<div class="d-flex justify-content-between align-items-center mb-3 mt-3 mx-3">
  <h2>Consulta de movimientos</h2>
</div>

<mat-divider></mat-divider>

<form class="mt-4 mx-4" *ngIf="form" [formGroup]="form" (ngSubmit)="onSearch()">
  <mat-card class="mb-3 p-4">
    <div class="flex flex-row gap-4">
      <div class="basis-1/4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Ingresar rango de fecha</mat-label>
          <mat-date-range-input [rangePicker]="picker">
            <input matStartDate formControlName="fromDate" placeholder="Fecha inicial" />
            <input matEndDate formControlName="toDate" placeholder="Fecha final" />
          </mat-date-range-input>
          <mat-hint>MM/DD/YYYY – MM/DD/YYYY</mat-hint>
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
      </div>

      <div class="basis-2/4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Fondo</mat-label>
          <mat-select formControlName="moneyFundId">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option *ngFor="let mf of moneyFunds" [value]="mf.Id">
              {{ mf.Name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="basis-3/4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Tipo</mat-label>
          <mat-select formControlName="movementType" (selectionChange)="onMovementTypeChange()">
            <mat-option value="All">Todos</mat-option>
            <mat-option value="Deposit">Deposito</mat-option>
            <mat-option value="Expense">Gasto</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="basis-4/4 text-left">
        <button mat-raised-button color="primary" type="submit">Buscar</button>
      </div>
    </div>
  </mat-card>
</form>

<mat-card class="mb-3 mx-4" *ngIf="filteredMovements.length > 0">
  <div class="grid grid-cols-3 gap-4">
    <div class="text-center">
      <div class="font-bold">Despósitos totales</div>
      <div>{{ totalDeposits | number : '1.2-2' }}</div>
    </div>
    <div class="text-center">
      <div class="font-bold">Gastos totales</div>
      <div>{{ totalExpenses | number : '1.2-2' }}</div>
    </div>
    <div class="text-center">
      <div class="font-bold">Balance neto</div>
      <div [ngClass]="{ 'text-green-600': netBalance >= 0, 'text-red-600': netBalance < 0 }">
        {{ netBalance | number : '1.2-2' }}
      </div>
    </div>
  </div>
</mat-card>

<mat-card class="mx-4" *ngIf="filteredMovements.length > 0">
  <table mat-table [dataSource]="filteredMovements" class="mat-elevation-z1 w-100">
    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef>Fecha</th>
      <td mat-cell *matCellDef="let row">
        {{ row.Date | date : 'short' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="movementType">
      <th mat-header-cell *matHeaderCellDef>Tipo</th>
      <td mat-cell *matCellDef="let row">
        <span
          class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium inset-ring"
          [ngClass]="{
            'bg-green-400/10 text-green-400 inset-ring-green-500/20': row.MovementType === 'Deposit',
            'bg-red-400/10 text-red-400 inset-ring-red-400/20': row.MovementType === 'Expense'
          }"
        >
          {{ row.MovementType === 'Deposit' ? 'Depósito' : 'Gasto' }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="moneyFundName">
      <th mat-header-cell *matHeaderCellDef>Fondo</th>
      <td mat-cell *matCellDef="let row">{{ row.MoneyFundName }}</td>
    </ng-container>

    <ng-container matColumnDef="amount">
      <th mat-header-cell *matHeaderCellDef>Monto</th>
      <td mat-cell *matCellDef="let row">
        <span
          [ngClass]="{
            'text-green-600': row.MovementType === 'Deposit',
            'text-red-600': row.MovementType === 'Expense'
          }"
        >
          {{ row.Amount | number : '1.2-2' }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef>Description</th>
      <td mat-cell *matCellDef="let row">
        {{ row.Description || '' }}
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>
</mat-card>

<mat-card class="mx-4 p-4" *ngIf="filteredMovements.length === 0 && movements.length === 0">
  <p class="mb-0">No hay movimientos encontrados con este rango.</p>
</mat-card>
